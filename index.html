<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ”¥ Tracker d'habitudes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
    <h1 class="text-3xl font-extrabold text-center mb-8 text-gray-900">ğŸ”¥ Tracker d'habitudes</h1>

    <div id="name-section" class="mb-8">
      <input
        id="username"
        type="text"
        placeholder="Entre ton nom"
        class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"
      />
      <button
        onclick="saveName()"
        class="w-full bg-blue-600 hover:bg-blue-700 transition-colors text-white py-3 rounded-lg font-semibold"
      >
        Entrer
      </button>
    </div>

    <div id="greeting" class="text-center text-2xl font-semibold text-gray-800 hidden mb-6"></div>

    <form id="habit-form" class="mb-6 hidden" autocomplete="off">
      <input
        type="text"
        id="habit-name"
        placeholder="Nouvelle habitude"
        required
        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
      />
      <button
        type="submit"
        class="w-full mt-4 bg-indigo-600 hover:bg-indigo-700 transition-colors text-white py-3 rounded-lg font-semibold"
      >
        Ajouter
      </button>
    </form>

    <div id="habits" class="space-y-4"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = localStorage.getItem("username") || "";
    let unsubscribe = null;

    async function saveName() {
      const input = document.getElementById("username");
      const name = input.value.trim();
      if (!name) return;
      currentUser = name;
      localStorage.setItem("username", name);
      document.getElementById("greeting").textContent = `Bienvenue, ${name} !`;
      document.getElementById("greeting").classList.remove("hidden");
      document.getElementById("name-section").classList.add("hidden");
      document.getElementById("habit-form").classList.remove("hidden");
      startListeningHabits();
    }

    document.getElementById("habit-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("habit-name").value.trim();
      if (!name || !currentUser) return;
      const docRef = await db.collection("habits").add({
        owner: currentUser,
        name,
        series: 0,
        freezes: 3,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      console.log("Nouvel ID:", docRef.id);
      document.getElementById("habit-name").value = "";
    });

    function startListeningHabits() {
      const container = document.getElementById("habits");
      if (unsubscribe) unsubscribe();

      unsubscribe = db
        .collection("habits")
        .where("owner", "==", currentUser)
        .orderBy("createdAt")
        .onSnapshot((snapshot) => {
          container.innerHTML = "";
          snapshot.forEach((doc) => {
            const habit = doc.data();
            const el = document.createElement("div");
            el.className =
              "bg-white p-5 rounded-xl shadow-md border border-gray-200 hover:shadow-lg transition-shadow";
            el.innerHTML = `
              <h3 class="font-bold text-xl mb-2 text-gray-900">${habit.name}</h3>
              <p class="text-gray-700 mb-1">SÃ©rie : <span class="text-orange-500 font-bold">${habit.series}</span> ğŸ”¥</p>
              <p class="text-gray-700 mb-3">Gels disponibles : <span class="font-semibold">${habit.freezes}</span></p>
              <p class="text-xs text-gray-400 mb-3 select-all">ID: ${doc.id}</p>
              <div class="space-x-3">
                <button onclick="markDone('${doc.id}', ${habit.series})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors font-semibold">âœ… Fait</button>
                <button onclick="useFreeze('${doc.id}', ${habit.freezes})" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-semibold">ğŸ§Š Gel</button>
                <button onclick="deleteHabit('${doc.id}')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors font-semibold">âŒ Supprimer</button>
              </div>
            `;
            container.appendChild(el);
          });
        });
    }

    async function markDone(id, currentSeries) {
      await db.collection("habits").doc(id).update({
        series: currentSeries + 1,
      });
    }

    async function useFreeze(id, currentFreezes) {
      if (currentFreezes > 0) {
        await db.collection("habits").doc(id).update({
          freezes: currentFreezes - 1,
        });
      } else {
        alert("Plus de gels disponibles !");
      }
    }

    async function deleteHabit(id) {
      if (confirm("Supprimer cette habitude ?")) {
        await db.collection("habits").doc(id).delete();
      }
    }

    if (currentUser) {
      document.getElementById("greeting").textContent = `Bienvenue, ${currentUser} !`;
      document.getElementById("greeting").classList.remove("hidden");
      document.getElementById("name-section").classList.add("hidden");
      document.getElementById("habit-form").classList.remove("hidden");
      startListeningHabits();
    }
  </script>
</body>
</html>
