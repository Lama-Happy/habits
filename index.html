<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üî• Tracker d'habitudes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-center mb-6">üî• Tracker d'habitudes</h1>

    <div id="name-section" class="mb-6">
      <input
        id="username"
        type="text"
        placeholder="Entre ton nom"
        class="w-full p-2 border rounded mb-2"
      />
      <button onclick="saveName()" class="bg-blue-500 text-white w-full py-2 rounded">
        Entrer
      </button>
    </div>

    <div id="greeting" class="text-center text-xl font-semibold hidden mb-4"></div>

    <form id="habit-form" class="mb-4 hidden">
      <input
        type="text"
        id="habit-name"
        placeholder="Nouvelle habitude"
        required
        class="w-full p-2 border rounded"
      />
      <button class="bg-indigo-500 text-white w-full py-2 mt-2 rounded" type="submit">
        Ajouter
      </button>
    </form>

    <div id="habits"></div>
  </div>

  <script>
    // Config Firebase ‚Äì remplace avec tes infos
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentUser = localStorage.getItem("username") || "";

    function displayHabit(habitId, habit) {
      const container = document.getElementById("habits");
      // Si √©l√©ment existe d√©j√†, on le met √† jour
      let el = document.getElementById(`habit-${habitId}`);
      if (!el) {
        el = document.createElement("div");
        el.id = `habit-${habitId}`;
        el.className = "bg-gray-50 p-4 rounded mb-2 shadow";
        container.appendChild(el);
      }
      el.innerHTML = `
        <h3 class="font-semibold text-lg">${habit.name}</h3>
        <p>S√©rie : <span class="text-orange-500 font-bold">${habit.series}</span> üî•</p>
        <p>Gels disponibles : ${habit.freezes}</p>
        <div class="mt-2 space-x-2">
          <button onclick="markDone('${habitId}', ${habit.series})" class="bg-green-500 text-white px-2 py-1 rounded">‚úÖ Fait</button>
          <button onclick="useFreeze('${habitId}', ${habit.freezes})" class="bg-blue-500 text-white px-2 py-1 rounded">üßä Gel</button>
          <button onclick="deleteHabit('${habitId}')" class="bg-red-500 text-white px-2 py-1 rounded">‚ùå</button>
        </div>
      `;
    }

    async function saveName() {
      const input = document.getElementById("username");
      const name = input.value.trim();
      if (!name) return;
      currentUser = name;
      localStorage.setItem("username", name);
      document.getElementById("greeting").textContent = `Bienvenue, ${name} !`;
      document.getElementById("greeting").classList.remove("hidden");
      document.getElementById("name-section").classList.add("hidden");
      document.getElementById("habit-form").classList.remove("hidden");

      // D√©marrer l'√©coute temps r√©el des habitudes
      subscribeHabits();
    }

    document.getElementById("habit-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("habit-name").value.trim();
      if (!name || !currentUser) return;

      // ID temporaire local (timestamp + random)
      const tempId = "temp-" + Date.now() + "-" + Math.floor(Math.random() * 1000);

      // Affichage imm√©diat
      displayHabit(tempId, { name, series: 0, freezes: 3 });

      // Clear input
      document.getElementById("habit-name").value = "";

      try {
        // Envoi √† Firebase
        await db.collection("habits").add({
          owner: currentUser,
          name,
          series: 0,
          freezes: 3,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // Pas besoin de reload ici, l'√©coute temps r√©el va mettre √† jour la liste
      } catch (err) {
        alert("Erreur lors de l'ajout de l'habitude.");
        console.error(err);
        // Supprimer l'√©l√©ment temporaire affich√© en cas d'erreur
        const tempEl = document.getElementById(`habit-${tempId}`);
        if (tempEl) tempEl.remove();
      }
    });

    function subscribeHabits() {
      const container = document.getElementById("habits");
      container.innerHTML = ""; // vide la liste au d√©part

      db.collection("habits")
        .where("owner", "==", currentUser)
        .orderBy("createdAt")
        .onSnapshot((snapshot) => {
          container.innerHTML = "";
          snapshot.forEach((doc) => {
            displayHabit(doc.id, doc.data());
          });
        });
    }

    async function markDone(id, currentSeries) {
      await db.collection("habits").doc(id).update({
        series: currentSeries + 1
      });
      // L'√©coute temps r√©el rafra√Æchira la liste automatiquement
    }

    async function useFreeze(id, currentFreezes) {
      if (currentFreezes > 0) {
        await db.collection("habits").doc(id).update({
          freezes: currentFreezes - 1
        });
      } else {
        alert("Plus de gels disponibles !");
      }
    }

    async function deleteHabit(id) {
      if (confirm("Supprimer cette habitude ?")) {
        await db.collection("habits").doc(id).delete();
      }
    }

    // Chargement si nom d√©j√† en m√©moire
    if (currentUser) {
      document.getElementById("greeting").textContent = `Bienvenue, ${currentUser} !`;
      document.getElementById("greeting").classList.remove("hidden");
      document.getElementById("name-section").classList.add("hidden");
      document.getElementById("habit-form").classList.remove("hidden");
      subscribeHabits();
    }
  </script>
</body>
</html>
